# rocketmq-helm

```bash
 helm -n stonebird install rocketmq ./rocketmq-helm
```

# acl

 broker-config.yaml

```yaml
apiVersion: v1
data:
  BROKER_MEM: ' -Xms2g -Xmx2g -Xmn1g '
  broker-common.conf: |
    # brokerClusterName, brokerName, brokerId are automatically generated by the operator and do not set it manually!!!
    deleteWhen=04
    fileReservedTime=48
    flushDiskType=ASYNC_FLUSH
    # set brokerRole to ASYNC_MASTER or SYNC_MASTER. DO NOT set to SLAVE because the replica instance will automatically be set!!!
    brokerRole=ASYNC_MASTER
    aclEnable=true
kind: ConfigMap
metadata:
  name: broker-config
  namespace: stonebird
```

broker-plain-acl.yaml

```yaml
apiVersion: v1
data:
  plain_acl.yml: |
    # Licensed to the Apache Software Foundation (ASF) under one or more
    # contributor license agreements.  See the NOTICE file distributed with
    # this work for additional information regarding copyright ownership.
    # The ASF licenses this file to You under the Apache License, Version 2.0
    # (the "License"); you may not use this file except in compliance with
    # the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    #  Unless required by applicable law or agreed to in writing, software
    #  distributed under the License is distributed on an "AS IS" BASIS,
    #  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    #  See the License for the specific language governing permissions and
    #  limitations under the License.
    #
    #  doc:  https://rocketmq.apache.org/zh/docs/bestPractice/03access#7-acl-mqadmin%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4



    # globalWhiteRemoteAddresses:
    #   - 10.10.103.*
    #   - 192.168.0.*

    accounts:
      - accessKey: TZM194phlRpiNA9LFYs6lpch
        secretKey: 5r2qMCnCDzypgLYg7y01Dmt3
        # if it is admin, it could access all resources
        admin: true
        # whiteRemoteAddress:
        # defaultTopicPerm: DENY
        # defaultGroupPerm: SUB
        # topicPerms:
        #   - topicA=DENY
        #   - topicB=PUB|SUB
        #   - topicC=SUB
        # groupPerms:
        #   # the group should convert to retry topic
        #   - groupA=DENY
        #   - groupB=PUB|SUB
        #   - groupC=SUB

    #  - accessKey: rocketmq2
    #    secretKey: 12345678
    #    whiteRemoteAddress: 192.168.1.*
    #    # if it is admin, it could access all resources
    #    admin: true
kind: ConfigMap
metadata:
  name: broker-plain-acl
  namespace: stonebird
```

console.yaml

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: console-user-cm
  namespace: stonebird
data:
  users.properties: |-

    # This file supports hot change, any change will be auto-reloaded without Console restarting.
    # Format: a user per line, username=password[,N] #N is optional, 0 (Normal User); 1 (Admin)
    # Define Admin
    # =============用户名和密码规则「用户名=密码,权限」，这里的权限为1表示管理员，为0表示普通用户=============

    # 例如：admin=admin123,1

    admin=password,1
```

sts.yaml

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rocketmq-broker-0-master
  namespace: stonebird
spec:
  podManagementPolicy: OrderedReady
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: broker
      broker_cr: rocketmq-broker
  serviceName: ""
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: broker
        broker_cr: rocketmq-broker
    spec:
      containers:
      - env:
        - name: NAMESRV_ADDR
          value: 192.168.0.9:9876;
        - name: BROKER_ID
          value: "0"
        - name: BROKER_CLUSTER_NAME
          value: rocketmq-broker
        - name: BROKER_NAME
          value: rocketmq-broker-0
        - name: BROKER_MEM
          valueFrom:
            configMapKeyRef:
              key: BROKER_MEM
              name: broker-config
        image: 1245863260/rocketmq-broker:5.0.0-alpine-operator-0.3.0
        imagePullPolicy: IfNotPresent
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/bash
              - -c
              - echo Initial broker
        name: broker
        ports:
        - containerPort: 10909
          hostPort: 10909
          name: vip
          protocol: TCP
        - containerPort: 10911
          hostPort: 10911
          name: main
          protocol: TCP
        - containerPort: 10912
          hostPort: 10912
          name: ha
          protocol: TCP
        resources:
          limits:
            cpu: "4"
            memory: 4Gi
          requests:
            cpu: "2"
            memory: 4Gi
        securityContext: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /root/logs
          name: broker-storage
          subPath: logs/rocketmq-broker-0-master
        - mountPath: /root/store
          name: broker-storage
          subPath: store/rocketmq-broker-0-master
        - mountPath: /root/rocketmq/broker/conf/broker-common.conf
          name: broker-config
          subPath: broker-common.conf
        - mountPath: /root/rocketmq/broker/conf/plain_acl.yml
          name: broker-plain-acl
          readOnly: true
          subPath: plain_acl.yml
      dnsPolicy: ClusterFirst
      hostNetwork: true
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: broker-common.conf
            path: broker-common.conf
          name: broker-config
        name: broker-config
      - configMap:
          defaultMode: 420
          name: broker-plain-acl
        name: broker-plain-acl
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      creationTimestamp: null
      name: broker-storage
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
      storageClassName: rook-cephfs
      volumeMode: Filesystem1

```

console_deployment.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rocketmq-console
  namespace: stonebird
  ownerReferences:
  - apiVersion: rocketmq.apache.org/v1alpha1
    blockOwnerDeletion: true
    controller: true
    kind: Console
    name: rocketmq-console
    uid: 6ee3a188-4911-441c-a353-dd246eba2248
  resourceVersion: "19004200"
  uid: 38b225c1-6660-41ed-9c3a-4bf8e13b7c4a
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: rocketmq-console
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: rocketmq-console
    spec:
      containers:
      - env:
        - name: JAVA_OPTS
          value: -Drocketmq.namesrv.addr=rocketmq-nameserver:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false
            -Drocketmq.config.loginRequired=true -Drocketmq.config.accessKey=TZM194phlRpiNA9LFYs6lpch
            -Drocketmq.config.secretKey=5r2qMCnCDzypgLYg7y01Dmt3
        image: 1245863260/rocketmq-dashboard:v2.0.1
        imagePullPolicy: IfNotPresent
        name: console
        ports:
        - containerPort: 8080
          protocol: TCP
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /tmp/rocketmq-console/data/users.properties
          name: console-user-cm
          readOnly: true
          subPath: users.properties
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
          defaultMode: 420
          name: console-user-cm
        name: console-user-cm

```



